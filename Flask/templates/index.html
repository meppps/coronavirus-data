<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <!-- <p>{{ corona  }}</p> -->
    <select name="" id="countrySelect"></select>
    <div id="myDiv"></div>

    <select name="" id="compr1"></select>
    <select name="" id="compr2"></select>
    <select name="" id="compr3"></select>
    <select name="" id="compr4"></select>
    <select name="" id="metric"></select>
    <div id="compare"></div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/1.33.1/plotly.min.js"></script>
<script>


    // === Load in data === //
    var data = {{ corona | tojson | safe }};
    var rona = JSON.parse(data);
    var obj = rona[0];

    // === Predefined functions === //
    function findIndex(country){
        for(i=0;i<list.length;i++){
            if(country === list[i]){
                return i;
            }
        }
    };

    function parseNum(num){
        if(num){

            if(num.includes('+')){
                num = num.replace('+','');
            };
            if(num.includes(',')){
                num = num.replace(',','');
            };
            return Number(num)
        }
    };

    // ===================== //
    // === Initial plot === //
    // ===================== //

    var totalCases = obj['TotalCases'][0];
    var newCases = parseNum(obj['NewCases'][0]);
    var totalRecovered = obj['TotalRecovered'][0];
    var totalDeaths = obj['TotalDeaths'][0];
    var newDeaths = parseInt(obj['NewDeaths'][0]);
    var activeCases = obj['ActiveCases'][0];

   


    var set = [
        {
            // title: country,
            x: ['Total Cases', 'Active Cases','New Cases','Recovered','Deaths'],
            y: [totalCases ,activeCases, newCases, totalRecovered, totalDeaths],
            type: 'bar',
            marker:{
            color: ['#856c8b', '#ff7f50', '#ffeb99', '#a7e9af', '#f67280']
            }
        }
    ];


    Plotly.newPlot('myDiv',set);



    // Create list of countries
    var countries = obj['Country,Other'];
    var length = Object.values(countries).length;
    var list = [];
    for(i=0;i<length;i++){

        var option = document.createElement('option');
        option.text = countries[i];
        option.value = countries[i];
        var select = document.getElementById('countrySelect');
        select.appendChild(option);
        list.push(countries[i]);

    };

    // ==== Update Plot === //
    document.getElementById('countrySelect').addEventListener('change',()=>{

        // Get values
        var country = document.getElementById('countrySelect').value;
        var index = findIndex(country);
        var totalCases = obj['TotalCases'][index];
        var newCases = parseNum(obj['NewCases'][index]);
        var totalRecovered = obj['TotalRecovered'][index];
        var totalDeaths = obj['TotalDeaths'][index];
        var newDeaths = parseInt(obj['NewDeaths'][index]);
        var activeCases = obj['ActiveCases'][index];


        // Plot
        var set = [
        {
            x: ['Total Cases', 'Active Cases','New Cases','Recovered','Deaths'],
            y: [totalCases ,activeCases, newCases, totalRecovered, totalDeaths],
            type: 'bar',
            marker:{
        color: ['#856c8b', '#ff7f50', '#ffeb99', '#a7e9af', '#f67280']
        }}
        ];

        Plotly.newPlot('myDiv', set);


    });
    
              
        
    // ===================== //
    // Country Comparison //
    // ===================== //


    function initComp(){

        // Define selectors
        var compr1 = document.getElementById('compr1');
        var compr2 = document.getElementById('compr2');
        var metricSelector = document.getElementById('metric');
        var metrics = ['Total Cases','Active Cases','New Cases','Recovered','Deaths'];


        function getMetric(m){
            return m === 'Total Cases' ? 'TotalCases':
            m === 'Active Cases' ? 'ActiveCases':
            m === 'New Cases' ? 'NewCases':
            m === 'Recovered' ? 'TotalRecovered':
            m === 'Deaths' ? 'TotalDeaths':
            'None';
        };


        // Metric selector
        metrics.forEach((met)=>{
            var option = document.createElement('option');
            option.value = met;
            option.text = met;
            metricSelector.appendChild(option);
        });

        // Country selector
        function initSelector(selector){
            list.forEach((country)=>{
            var option = document.createElement('option');

            option.text = country;
            option.value = country;
            selector.appendChild(option)
            });
        }; 

        // Initial plot
        initSelector(compr1);
        initSelector(compr2);
        initSelector(compr3);
        initSelector(compr4);


        var total1 = obj['TotalCases'][1];
        var total2 = obj['TotalCases'][2];
        var total3 = obj['TotalCases'][3];
        var total4 = obj['TotalCases'][4];


        var comp = [
            {
                x:[total1,total2,total3,total4],
                y:[list[1],list[2],list[3],list[4]],
                orientation: 'h',
                type:'bar',
                marker:{
                    color: ['orange','lightblue','lightgreen','lightred']
                }
            }
        ];

        Plotly.newPlot('compare', comp);



    // ===================== //
    // Dynamic functionality //
    // ===================== //

    var selectorList = [compr1,compr2,compr3,compr4,metricSelector];
    var selection = 0;

        selectorList.forEach((selector)=>{
            if(selector != metricSelector){
                selector.selectedIndex = selection += 1;
        };

            // Update
            addEventListener('change',()=>{
                
                // Compare by metric
                var metric = document.getElementById('metric').value;

                // Country
                var country1 = compr1.value;
                var country2 = compr2.value;
                var country3 = compr3.value;
                var country4 = compr4.value;

                // Index
                var index1 = findIndex(country1);
                var index2 = findIndex(country2);
                var index3 = findIndex(country3);
                var index4 = findIndex(country4);

                // Get figure
                var total1 = obj[getMetric(metric)][index1];
                var total2 = obj[getMetric(metric)][index2];
                var total3 = obj[getMetric(metric)][index3];
                var total4 = obj[getMetric(metric)][index4];
                
                // Plot
                var comp = [
                    {
                        x:[total1,total2,total3,total4],
                        y:[country1,country2,country3,country4],
                        orientation:'h',
                        type:'bar',
                        marker:{
                            color: ['green','blue','red','orange']
                        }
                    }
                ];
            
                Plotly.newPlot('compare',comp)
            })
        });


    };
    initComp();
    

</script>
</html>